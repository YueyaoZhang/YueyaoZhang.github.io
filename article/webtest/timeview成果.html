<html>  
<head>  
	<meta charset="utf-8">  
	 <link href="VisCss.css" rel="stylesheet" type="text/css"/>
	<title>Water Pollution Vis</title>  
	<script src="js/xlsx.core.min.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script> 

 <meta charset="UTF-8">
    <script type="text/javascript" src="js/x3dom-full.debug.js"></script>
    <script type="text/javascript" src="js/d3.v3.min.js"></script>
    <script type="text/javascript" src="js/heat_map.js"></script>
    <script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>

    <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="css/x3dom.css">
    <style type="text/css">
        .setmargin{margin-left: 60px;}
    </style>





<style>
</style>
</head> 
<body>   
<div title="The Introduction of this Vis" class="toptitle">
Who Has Polluted Our Water?
</div>
<div> 
<div id="WholeView" style="width: 99%;height:98%;z-index:0;position:absolute;">
<script>

</script>
	 <div id="MainView" style="width: 100%;height:100%;z-index:1;position:absolute;margin-top:100px;margin-left:0px;background-color:rgba(255,255,255,0.5);">
	 
	 <script>
var heatMapDatas = [];
	 <!-- >MainView 代码< -->
	   var colorarr = [
[39,55,69,79,72,61,68,42,42,55,41,26],
[44,43,50,57,56,24,24,47,37,26,39,23],
[37,29,38,22,74,34,61,49,35,36,29,50],
[44,37,46,44,47,27,33,37,37,36,36,48],
[45,40,62,46,51,52,33,31,47,53,65,52],
[32,68,74,57,82,49,43,67,71,96,47,53],
[71,71,59,78,107,86,80,72,73,83,81,60]]

var timearr = [
"1998/1",
"1998/2",
"1998/3",
"1998/4",
"1998/5",
"1998/6",
"1998/7",
"1998/8",
"1998/9",
"1998/10",
"1998/11",
"1998/12",
"1999/1",
"1999/2",
"1999/3",
"1999/4",
"1999/5",
"1999/6",
"1999/7",
"1999/8",
"1999/9",
"1999/10",
"1999/11",
"1999/12",
"2000/1",
"2000/2",
"2000/3",
"2000/4",
"2000/5",
"2000/6",
"2000/7",
"2000/8",
"2000/9",
"2000/10",
"2000/11",
"2000/12",
"2001/1",
"2001/2",
"2001/3",
"2001/4",
"2001/5",
"2001/6",
"2001/7",
"2001/8",
"2001/9",
"2001/10",
"2001/11",
"2001/12",
"2002/1",
"2002/2",
"2002/3",
"2002/4",
"2002/5",
"2002/6",
"2002/7",
"2002/8",
"2002/9",
"2002/10",
"2002/11",
"2002/12",
"2003/1",
"2003/2",
"2003/3",
"2003/4",
"2003/5",
"2003/6",
"2003/7",
"2003/8",
"2003/9",
"2003/10",
"2003/11",
"2003/12",
"2004/1",
"2004/2",
"2004/3",
"2004/4",
"2004/5",
"2004/6",
"2004/7",
"2004/8",
"2004/9",
"2004/10",
"2004/11",
"2004/12",
"2005/1",
"2005/2",
"2005/3",
"2005/4",
"2005/5",
"2005/6",
"2005/7",
"2005/8",
"2005/9",
"2005/10",
"2005/11",
"2005/12",
"2006/1",
"2006/2",
"2006/3",
"2006/4",
"2006/5",
"2006/6",
"2006/7",
"2006/8",
"2006/9",
"2006/10",
"2006/11",
"2006/12",
"2007/1",
"2007/2",
"2007/3",
"2007/4",
"2007/5",
"2007/6",
"2007/7",
"2007/8",
"2007/9",
"2007/10",
"2007/11",
"2007/12",
"2008/1",
"2008/2",
"2008/3",
"2008/4",
"2008/5",
"2008/6",
"2008/7",
"2008/8",
"2008/9",
"2008/10",
"2008/11",
"2008/12",
"2009/1",
"2009/2",
"2009/3",
"2009/4",
"2009/5",
"2009/6",
"2009/7",
"2009/8",
"2009/9",
"2009/10",
"2009/11",
"2009/12",
"2010/1",
"2010/2",
"2010/3",
"2010/4",
"2010/5",
"2010/6",
"2010/7",
"2010/8",
"2010/9",
"2010/10",
"2010/11",
"2010/12",
"2011/1",
"2011/2",
"2011/3",
"2011/4",
"2011/5",
"2011/6",
"2011/7",
"2011/8",
"2011/9",
"2011/10",
"2011/11",
"2011/12",
"2012/1",
"2012/2",
"2012/3",
"2012/4",
"2012/5",
"2012/6",
"2012/7",
"2012/8",
"2012/9",
"2012/10",
"2012/11",
"2012/12",
"2013/1",
"2013/2",
"2013/3",
"2013/4",
"2013/5",
"2013/6",
"2013/7",
"2013/8",
"2013/9",
"2013/10",
"2013/11",
"2013/12",
"2014/1",
"2014/2",
"2014/3",
"2014/4",
"2014/5",
"2014/6",
"2014/7",
"2014/8",
"2014/9",
"2014/10",
"2014/11",
"2014/12",
"2015/1",
"2015/2",
"2015/3",
"2015/4",
"2015/5",
"2015/6",
"2015/7",
"2015/8",
"2015/9",
"2015/10",
"2015/11",
"2015/12",
"2016/1",
"2016/2",
"2016/3",
"2016/4",
"2016/5",
"2016/6",
"2016/7",
"2016/8",
"2016/9",
"2016/10",
"2016/11",
"2016/12"
]

var objectarr= [
"Anthracene",
"Arsenic",
"Barium",
"Benzo(a)anthracene",
"Benzo(a)pyrene",
"Benzo(b)fluoranthene",
"Benzo(k)fluoranthene",
"Cadmium",
"Chlorides",
"Chrysene",
"Copper",
"Cyanides",
"Endosulfan (alpha)",
"Endosulfan (beta)",
"Endrin",
"Fluoranthene",
"Fluorene",
"Heptachloroepoxide",
"Hexachlorobenzene",
"Indeno(1,2,3-c,d)pyrene",
"Iron",
"Lead",
"Manganese",
"Mercury",
"Methoxychlor",
"Nickel",
"Potassium",
"Selenium",
"Tetrachloromethane"
]
var i ;
var j ;
var k = 0;
var svgDom;
var polygonDom;
var heatMapDatas = [];
var nowWhere ='Kohsoom';

var nowKind =objectarr[0];   //循环绘制35多种要素 先绘制一个地点的
console.log(nowWhere);
svgDom = document.createElementNS('http://www.w3.org/2000/svg','svg');		
svgDom.setAttribute('width','1600');
svgDom.setAttribute('height','600');
document.body.appendChild(svgDom);
drawButton();
 drawHeatMapFromCSV();




 
 //pressButton(nowWhere,nowKind);外部使用是没用的
//console.log(console.log(heatMapDatas[0]["datas"]+"push"));
window.onload = function () {
             document.getElementById('location').addEventListener('change',function(){
			     nowWhere = this.value;
                 alert("当前选项是:"+nowWhere);
				 //document.body.removeChild(svgDom);
				 
        for(var i = svgDom.childNodes.length - 1; i >= 0; i--) { 
          //alert(svgDom.childNodes[i].nodeName); 
         svgDom.removeChild(svgDom.childNodes[i]); 
           }


				 //svgDom.removeChild();
//var svgDom;	
//svgDom = document.createElementNS('http://www.w3.org/2000/svg','svg');		
//svgDom.setAttribute('width','1600');
//svgDom.setAttribute('height','600');
//document.body.appendChild(svgDom);			 
				 drawButton();
                 drawHeatMapFromCSV();
             },false);
         }
//数据获取
function pressButton(where){
   
    nowWhere = where;
    

	for( i = 0; i < objectarr.length; i++) {//循环有问题啊
	nowKind = objectarr[i];
	console.log(i+objectarr[i]);
	 //获取当前地点的数据
    var datas = [];
    for(var index=0; index < heatMapDatas.length; index++){
        if (heatMapDatas[index]["place"] == nowWhere&&heatMapDatas[index]["kind"] == nowKind){
            datas = heatMapDatas[index]["datas"];//该种物质的时间轴数据
			console.log(datas);//每种物质只搜到部分数据
            break;
        }
    }
	//console.log(datas);
  for( j = 0; j < timearr.length; j++) {   //绘制一行  //如何能够统一时间轴呢？看看共有多少天的属性，做个匹配、空的就空着 表达属性的缺失

  if (datas.length>=1&&datas[k][0]==timearr[j]&&(k+1)<datas.length&&datas[k][0]!=datas[k+1][0]){  //怀疑没有搜索到全部J  j没有归零吧
  console.log(datas.length+"Len"+k+datas[k][0]+"J"+j);   //k代表的月份有重复的
var polygonDom;
var vertexX = j*10+20;//整体平移
var vertexY = i*10+100;
var vertexX2 =j*10+10+20; //整体平移
var vertexY2 =i*10+10+100;
var weight = 10;
var sizejust =(1-Math.abs(datas[k][1])*1000/10)*3.5;//这个值可能为0  或者为负数
//var sizejust =(1-colorarr[i][j]/107)*3.5;
var colors = Math.round((1-Math.abs(datas[k][1])*1000/80)*200);

//必须要用ij来设置位置啊  颜色想用渐变色   i决定y  j决定x      横轴X
//对数比例 ?  
//if(colorarr[i][j]>=1000 )
polygonDom = document.createElementNS('http://www.w3.org/2000/svg','polygon');
var polygonarr1 = '50,50 70,50 70,70 50,70';//示例坐标
 //设置一定的间隔
var polygonarr = (vertexX+1).toString()+','+(vertexY+1).toString()+' '+vertexX2.toString()+','+(vertexY+1).toString()+' '+vertexX2.toString()+','+vertexY2.toString()+' '+(vertexX+1).toString()+','+vertexY2.toString();
//var polygonarr = (vertexX+sizejust).toString()+','+(vertexY+sizejust).toString()+' '+(vertexX2-sizejust).toString()+','+(vertexY+sizejust).toString()+' '+(vertexX2-sizejust).toString()+','+(vertexY2-sizejust).toString()+' '+(vertexX+sizejust).toString()+','+(vertexY2-sizejust).toString();
//document.write(colors);
polygonDom.setAttribute('points',polygonarr);//不可以用变量代替位置，  顺时针连接   取出该字符串？
//是否存在色值连续的色带  十六进制加一即可？（255，X，0）  转16进制    0~m~1652  (1-m/1652)*255  远离红色的程度
//polygonDom.setAttribute('style','fill:rgb(255, 0, 0);strock:#ccc;stroke-width:1;');
var colorset = 'fill:rgb(100,'+colors.toString()+', 0);';
polygonDom.setAttribute('style',colorset);
svgDom.appendChild(polygonDom);	
  
  k++;
  }
}

k = 0;//重置k 未能进入二轮循环
}
	
	
   
   
}




/*
var LineDom = document.createElementNS('http://www.w3.org/2000/svg','polygon');
var Linearr = '184,5 185,5 185,598 184,598';//示例坐标
LineDom.setAttribute('points',Linearr);//不可以用变量代替位置，  顺时针连接   取出该字符串？
LineDom.setAttribute('style','fill:rgb(255, 180, 0);');
svgDom.appendChild(LineDom);	
*/

//数据获取

function drawHeatMapFromCSV(filePath) {
/*var svgDom;
svgDom = document.createElementNS('http://www.w3.org/2000/svg','svg');		
svgDom.setAttribute('width','1600');
svgDom.setAttribute('height','600');
document.body.appendChild(svgDom);
*/
    var filePath = './csv/test1.csv';

    d3.csv(filePath, function(error, csvdata){
       

        if(error){
            alert("请输入正确的文件目录");
        }

        var indexCSV = 0;
        while (typeof csvdata[indexCSV] != "undefined"){
            var time = csvdata[indexCSV]["sampledate"];
           	var tim=[];
           	tim=time.split('/');
           	time=tim[0]+'/'+tim[1];
            var kind = csvdata[indexCSV]["measure"]		
            var x = csvdata[indexCSV]["X"];
            var y = csvdata[indexCSV]["value"];
			var place = csvdata[indexCSV]["location"];
            var z = csvdata[indexCSV]["Y"];
            for( var index=0;index < heatMapDatas.length; index += 1){
                if(heatMapDatas[index]["place"] == place&&heatMapDatas[index]["kind"]==kind){
                    heatMapDatas[index]["datas"].push([time,y]);//暂存？w
					//heatMapDatas[index]["time"].push(y);
					//heatMapDatas[index]["datas"]=y;
                   
                  //console.log(heatMapDatas[index]["datas"]+"push");//已经读取到了数据
                    break;
                }
            }


            indexCSV += 1;
        }

       
        
        pressButton(nowWhere);
    });
	   console.log(heatMapDatas[8]["datas"]);//此处就无法取出数据了
      //return svgDom;
}

function drawButton() {
        var timeRange =[];
        for(var i=1998;i<=2016;i+=1)
        {
        	for(var j=1;j<=12;j+=1)
        	{
        		timeRange.push(i+'/'+j);
        	}
        }

       
        var kindRange = ["measure",
"1,2,3-Trichlorobenzene","1,2,4-Trichlorobenzene","Acenaphthene","Acenaphthylene","AGOC-3A","Alachlor","Aldrin","alpha-Hexachlorocyclohexane","Aluminium",
"Ammonium","Anionic active surfactants","Anthracene","AOX","Arsenic","Atrazine","Barium","Benzo(a)anthracene","Benzo(a)pyrene","Benzo(b)fluoranthene",
"Benzo(g,h,i)perylene","Benzo(k)fluoranthene","Berilium","beta-Hexaxchlorocyclohexane","Bicarbonates","Biochemical Oxygen","Boron","Cadmium",
"Calcium","Carbonates","Cesium","Chemical Oxygen Demand (Cr)","Chemical Oxygen Demand (Mn)","Chlorides","Chlorodinine","Chromium","Chrysene",
"Copper","Cyanides","Dieldrin","Dissolved organic carbon","Dissolved oxygen","Dissolved silicates","Endosulfan (alpha)","Endosulfan (beta)","Endrin",
"Fecal coliforms","Fecal streptococci ","Fluoranthene","Fluorene","gamma-Hexachlorocyclohexane","Heptachlor","Heptachloroepoxide","Hexachlorobenzene",
"Indeno(1,2,3-c,d)pyrene","Inorganic nitrogen","Iron","Isodrin","Lead","Macrozoobenthos","Magnesium","Manganese","Mercury","Methoxychlor",
"Methylosmoline","Metolachlor","Naphthalene","Nickel","Nitrates","Nitrites","Organic nitrogen","Orthophosphate-phosphorus","Oxygen saturation",
"p,p-DDD","p,p-DDE","p,p-DDT","PAHs","PCB 101","PCB 118","PCB 138","PCB 153","PCB 180","PCB 28","PCB 52","Pentachlorobenzene","Petroleum hydrocarbons",
"Phenanthrene","Potassium","Pyrene","Selenium","Silica (SiO2)","Simazine","Sodium","Sulfides","Sulphates","Tetrachloromethane","Total coliforms",
"Total dissolved phosphorus","Total dissolved salts","Total extractable matter","Total hardness","Total nitrogen","Total organic carbon","Total phosphorus",
"Trifluralin","Water temperature","Zinc"];
var placeRange = ["Achara","Boonsri","Busarakhan","Chai","Decha","Kannika","Kohsoom","Sakda","Somchair","Tansanee"];
        initHeatMapDatas(kindRange,placeRange);
		console.log("drawButton");
    }	

    function initHeatMapDatas(kindrange,placeRange) {
        for(var place=0; place < placeRange.length; place += 1){
        	for(var kind =0;kind<=kindrange.length;kind+=1){
            //heatMapDatas.push({"time": timeRange[time],"place":placeRange[0],"kind":kindrange[kind],"datas":[]});
			heatMapDatas.push({"place": placeRange[place],"kind":kindrange[kind],"datas":[]});
        	}
        	}
			console.log("initHeatMapDatas");
        }
      
    
	 </script>
     </div>
	 
     </div>
	 	
	 <script>
<!-- 	 PlaceView 代码< -->
	</script>
	<div id="yAxies" style="width: 100%;height:10%;z-index:2;position:absolute;margin-top:80px;margin-left:50px;font-family: sans-serif;color:#000000;font-size: 12px">
 <p>1998&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 1999&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 2000&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 2001&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 2002&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 2003&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 2004&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 </p>
 </div>
 <div id="xAxies" style="width: 100%;height:10%;z-index:3;position:absolute;margin-top:80px;margin-left:850px;font-family: sans-serif;color:#000000;font-size: 12px">
 <p>2005&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 2006&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 2007&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 2008&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 2009&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 2010&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 2011&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
 </p>
 </div>
	<div id="Select" style="width: 30px;height:100px;z-index:2;position:absolute;margin-top:400px;margin-left:50px;background-color:rgba(255,255,255,0.5);">
	 <form action="">
	<select  id = "location">
  <option value ="Achara">Achara</option>
  <option value ="Boonsri">Boonsri</option>
  <option value="Busarakhan">Busarakhan</option>
  <option value="Chai">Chai</option>
  <option value ="Decha">Decha</option>
  <option value ="Kannika">Kannika</option>
  <option value ="Kohsoom">Kohsoom</option>
  <option value ="Sakda">Sakda</option>
  <option value ="Somchair">Somchair</option>
  <option value ="Tansanee">Tansanee</option>
</select>
 </form>
	</div>
	<script>
   

	 </script>

	 
</div>
</body>  
</html>  