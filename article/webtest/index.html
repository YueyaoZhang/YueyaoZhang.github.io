<!DOCTYPE html>

<meta charset="utf-8">
 <link href="VisCss.css" rel="stylesheet" type="text/css"/>
	<title>Water Pollution Vis</title>  
<style>
.toptitle{
	position:fixed; 
	top:10px;left:10px; 
	width:416px; height:65px; 
	z-index:2;
	font-family: sans-serif;
	color:#707070;
	font-size: 25px
}
.node {
  cursor: pointer;
}

.node:hover {
  stroke: #000;
  stroke-width: 1.5px;
}

.node--leaf {
  fill: white;
}

.label {
  font: 11px "Helvetica Neue", Helvetica, Arial, sans-serif;
  text-anchor: middle;
  text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
}

.label,
.node--root,
.node--leaf {
  pointer-events: none;
}
.setmargin{margin-left: 60px;}

</style>
<div title="The Introduction of this Vis" class="toptitle">
Who Has Polluted Our Water?
</div>
<div id="WholeView" style="width: 99%;height:99%;z-index:0;position:absolute;">
<div id="MainView" style="width: 70%;height:100%;z-index:1;position:absolute;margin-top:0px;margin-left:0px;background-color:rgba(255,255,255,0.5);">
<svg width="1000" height="600" ></svg>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>    
<script src="http://d3js.org/d3.v4.min.js" charset="utf-8"></script>  



<script>
var width = 1000;
var height = 800;
var placearrayX = [30,60,60,80,130,120,110,140,150,170];
var placearrayY = [130,100,160,70,130,30,210,180,70,90];
//顺序是Decha somc tansanee achara  chai boon sakada kanni  koh  busa
var placeRange = ["Decha","Somchair","Tansanee","Achara","Chai","Boonsri","Sakda","Kannika","Kohsoom","Busarakhan"];
var currentscale = 0;
var r =1;
//该例使用V4版本，同时使用
</script>

<script>
var contain = d3.select("body");
var svg = contain.select("svg");
//整体的缩放事件--------------------------------------------------------------
		var zoom = d3.behavior.zoom()
					.scaleExtent([1, 10])
					.on("zoom", zoomed); //想同时触发两个事件
       
		function zoomed() {
		      //点击事件
			
			console.log(d3.event.scale);//监听当前scale变化，传递给packzoom，重绘，清空图形
			d3.select(this).attr("transform", 
				"translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
			//listenzoom(d3.event.scale);
			currentscale = d3.event.scale;
			//没有写缩小事件
			for(var i=0;i<10;i++){     //写在函数里就不会覆盖前面绘制的图形,
	        CreatePack(placearrayX[i]*3,placearrayY[i]*2,r*currentscale);
	        }
		}
//整体的缩放事件--------------------------------------------------------------

svg.call(zoom);
var margin = 20;
var diameter = +svg.attr("width");

//数据定义
var catogary = ["Cadmium",
"Copper",
"Iron",
"Lead",
"Manganese"
];

var data200006 = [
["Boonsri","Cadmium",7.64],
["Boonsri","Copper",-0.194444444],
["Boonsri","Iron",-0.9996725],
["Boonsri","Lead",7.1],
["Boonsri","Manganese",-0.325],
["Sakda","Cadmium",3.26],
["Sakda","Copper",1.527777778],
["Sakda","Iron",-0.99903],
["Sakda","Lead",6.2],
["Sakda","Manganese",0.025],
["Kannika","Cadmium",5.16],
["Kannika","Copper",1.222222222],
["Kannika","Iron",-0.99881],
["Kannika","Lead",6.3],
["Kannika","Manganese",0.175],
["Busarakhan","Cadmium",4.4],
["Busarakhan","Copper",0.222222222],
["Busarakhan","Iron",-0.99823],
["Busarakhan","Lead",7],
["Busarakhan","Manganese",1.4],
["Somchair","Cadmium",3.36],
["Somchair","Copper",0.888888889],
["Somchair","Iron",-0.99759],
["Somchair","Lead",19.02],
["Somchair","Manganese",3.8],
["Chai","Cadmium",3.43],
["Chai","Copper",0.555555556],
["Chai","Iron",-0.998915],
["Chai","Lead",10.1],
["Chai","Manganese",-0.725],
["Kohsoom","Cadmium",6.16],
["Kohsoom","Copper",3.444444444],
["Kohsoom","Iron",-0.99747],
["Kohsoom","Lead",14.6],
["Kohsoom","Manganese",0.8]
]

/*
var data200009 = [
{"Boonsri","Cadmium",4.42
{"Boonsri","Copper",0.861111111
{"Boonsri","Iron",-0.9991375
{"Boonsri","Lead",14.5
{"Boonsri","Manganese",-0.15
{"Kohsoom","Cadmium",2.24
{"Kohsoom","Copper",0.555555556
{"Kohsoom","Iron",-0.99873
{"Kohsoom","Lead",12.2
{"Kohsoom","Manganese",0.6
{"Sakda","Cadmium",0.01
{"Sakda","Copper",0.972222222
{"Sakda","Iron",-0.99913
{"Sakda","Lead",12.1
{"Sakda","Manganese",-0.575
{"Chai","Cadmium",1.59
{"Chai","Copper",2.361111111
{"Chai","Iron",-0.9997275
{"Chai","Lead",10.1
{"Chai","Manganese",-0.8625
{"Kannika","Cadmium",2.29
{"Kannika","Copper",0.027777778
{"Kannika","Iron",-0.99944
{"Kannika","Lead",3.9
{"Kannika","Manganese",-0.725
{"Busarakhan","Cadmium",-0.8
{"Busarakhan","Copper",1.666666667
{"Busarakhan","Iron",-0.99829
{"Busarakhan","Lead",14.2
{"Busarakhan","Manganese",1.5
{"Somchair","Cadmium",6.52
{"Somchair","Copper",2.444444444
{"Somchair","Iron",-0.99796
{"Somchair","Lead",3.8
{"Somchair","Manganese",1.7
]

var data200012 = [
{"Chai","Cadmium",5.23},
{"Chai","Copper",0.861111111},
{"Chai","Iron",-0.99954},
{"Chai","Lead",6.6},
{"Chai","Manganese",-0.35},
{"Busarakhan","Cadmium",1.88},
{"Busarakhan","Copper",0.444444444},
{"Busarakhan","Iron",-0.99868},
{"Busarakhan","Lead",6.2},
{"Busarakhan","Manganese",-0.8},
{"Somchair","Cadmium",1.84},
{"Somchair","Copper",-0.555555556},
{"Somchair","Iron",-0.99838},
{"Somchair","Lead",15.4},
{"Somchair","Manganese",-0.5},
{"Boonsri","Cadmium",1.04},
{"Boonsri","Copper",0.055555556},
{"Boonsri","Iron",-0.999645},
{"Boonsri","Lead",4.8},
{"Boonsri","Manganese",-0.7875},
{"Kohsoom","Cadmium",4.96},
{"Kohsoom","Copper",0.333333333},
{"Kohsoom","Iron",-0.99873},
{"Kohsoom","Lead",5.4},
{"Kohsoom","Manganese",-0.4},
{"Kannika","Cadmium",4.13},
{"Kannika","Copper",4.222222222},
{"Kannika","Iron",-0.9984},
{"Kannika","Lead",4.2},
{"Kannika","Manganese",-0.775},
{"Sakda","Cadmium",4.17},
{"Sakda","Copper",0.111111111},
{"Sakda","Iron",-0.998575},
{"Sakda","Lead",4.9},
{"Sakda","Manganese",-0.775}
]
*/
//获取分时段数值
var dataforcircle = [];
var j =0;

for(var j =0; j < placeRange.length;j++){//按照地点外部循环
	   dataforcircle = [];  
  for(var  k =0; k < data200006.length;k++){  ////读取文件  选择同地点的 物质和量
  
     if(placeRange[j]==data200006[k][0]){
	 dataforcircle.push([data200006[k][1],data200006[k][2]]);
	 //console.log(dataforcircle);}
     }
	 //console.log(dataforcircle);//应该有一个地点的五类数据
	 CreatePack(placearrayX[j]*3,placearrayY[j]*2,1,dataforcircle,j);//绘制
  }
  }
  

//绘制pack包----------------------------------------------------------------
//for(var i=0;i<10;i++){     //写在函数里就不会覆盖前面绘制的图形,
	      //  CreatePack(placearrayX[i]*3,placearrayY[i]*2,r*currentscale);
	      //   }
	
function CreatePack(x,y,r,dataforcircle,j) {
//console.log("???"+dataforcircle[1]);
var g = svg.append("g").attr("transform", "translate(" + x + "," + y + ")");  //控制定位
	
var color = d3.scale.linear()
    .domain([-1, 5])
    .range(["hsl(152,80%,80%)", "hsl(228,30%,40%)"])
    .interpolate(d3.interpolateHcl);

var pack = d3.pack()
    .size([r, r])   //整体控制大小
    .padding(2);
	
d3.json("flare.json", function(error, root) {
  if (error) throw error;

  root = d3.hierarchy(root)
      .sum(function(d) { return d.size; })
      .sort(function(a, b) { return b.value - a.value; });

  var focus = root,
      nodes = pack(root).descendants(),
      view;

  var circle = g.selectAll("circle")   //在这里更改即可
    .data(nodes)
    .enter().append("circle")
      .attr("class", function(d) { return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"; })
      .style("fill", function(d) { return d.children ? color(d.depth) : null; })
      .on("click", function(d) { if (focus !== d) zoom(d), d3.event.stopPropagation(); });
	  
	  
	var circle2 = g.selectAll("circle2")   //在这里更改即可
    .data(dataforcircle)
    .enter().append("circle2");
     /*  .attr("cx",function(d,i){
	   console.log("明天再来设置颜色和大小还有外部循环");
	   return placearrayX[j]*3+Math.random() * 30;})
		  .attr("cy",function(d,i){return placearrayY[j]*2+Math.random() * 30;})
		  .attr("r",function(d,i){return 20;});
     // .style("fill", function(d) { return  "red" ; })
     // .on("click", function(d) { if (focus !== d) zoom(d), d3.event.stopPropagation(); });
	  //当前绘制案例  placeRange[i]   时间j
	  //取出五类数值
	  */
	
	  

	/*
	//扇形区域  
	
	var arc = d3.svg.arc()
			.startAngle(0)
			.endAngle(30)
			.innerRadius(0)
			.outerRadius(50);
	
	var arcs = svg.selectAll("g")
				  .data(nodes)
				  .enter().append("g");
	
	arcs.append("path")
		.attr("display", function(d) { return d.depth ? null : "none"; }) // hide inner ring
		.attr("d", arc)
		.style("stroke", "#fff");
		
	*/

 /* var text = g.selectAll("text")
    .data(nodes)
    .enter().append("text")
      .attr("class", "label")
      .style("fill-opacity", function(d) { return d.parent === root ? 1 : 0; })
      .style("display", function(d) { return d.parent === root ? "inline" : "none"; })
      .text(function(d) { return d.data.name; });
	  */
   //绘制曲线
var data = [0, 12, 3, 4, 5, 6, 9];//可以自己插值得出
var data2 = [{"x":1,"y":5},  {"x":20,"y":30}];//可以自己插值得出
var scale_x = d3.scale.linear()//把曲线沿x轴按比例放大
//.domain([0, Math.abs(placearrayX[i]-placearrayX[i+1])])
.domain([0, 6])
.range([0, 2]);
var scale_y = d3.scale.linear()//把曲线沿y轴按比例放大
.domain([0, 6])
.range([0, 2]);


var line_generator = d3.svg.line()//d3中绘制曲线的函数
.x(function(d, i){return scale_x(i);})//曲线中x的值
.y(function(d){return scale_y(d);})//曲线中y的值
.interpolate("cardinal")//把曲线设置光滑

d3.select("g")
.append("path")
.attr("d", line_generator(data));
/*
var link= svg.selectAll("path")
    .data(data2)
  .enter().append("path")
    .attr("d",d3.svg.diagonal())
    .attr("class", ".link")
    .attr("stroke", "black")
    .attr("stroke-width", "2px")
    .attr("shape-rendering", "auto")
    .attr("fill", "none");  
	*/
	
console.log(data2[1].y);

	  
	  
  var node = g.selectAll("circle,text");

  svg.style("background", "white")   //背景色
      .on("click", function() { zoom(root); });  //点击事件
	   //.on("zoom", zoomed);  //为pack添加整体放缩事件

  zoomTo([root.x, root.y, root.r * 2 + margin]);

 
  function zoom(d) {
    var focus0 = focus; focus = d;

    var transition = d3.transition()
        .duration(d3.event.altKey ? 7500 : 750)
        .tween("zoom", function(d) {
          var i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2 + margin]);
		  //zoomed;
          return function(t) { zoomTo(i(t)); };
        });

    transition.selectAll("text")
      .filter(function(d) { return d.parent === focus || this.style.display === "inline"; })
        .style("fill-opacity", function(d) { return d.parent === focus ? 1 : 0; })
        .on("start", function(d) { if (d.parent === focus) this.style.display = "inline"; })
        .on("end", function(d) { if (d.parent !== focus) this.style.display = "none"; });
  }

  function zoomTo(v) {
    var k = diameter / v[2]; view = v;
    node.attr("transform", function(d) { return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")"; });
    circle.attr("r", function(d) { return d.r * k; });
  }
});

} //函数
//}  //for 循环


//绘制贝塞尔曲线开始---------------------------------------------------------------------------
//var data3 = [ {name: "p1", children: [{name: "c1"}, {name: "c2"}, {name: "c3"}, {name: "c4"}]}];
//数据结构：node-children
 
var data4 = [ 
{name: "Decha",X:90,Y:260,
 children: [ 
 {children: [ ]}
 ]},
{name: "Tansanee",X:180,Y:320,
 children: [ 
 {children: [ ]}
 ]},
{
name: "Sakda",X:330,Y:420,
children: 
[
{name: "Somachair",X:180,Y:200,
children: [ ]}, 
{name: "Achara",X:240,Y:140,
children: [ ]}
]
},
{name: "Kannika",X:420,Y:360,
children: 
[
{name: "Chai",X:390,Y:260,
children: 
[
{name: "Kohsoom",X:450,Y:140}, 
{name: "Boonsri",X:360,Y:60}
]
}, 
{name: "Busakrahan",X:510,Y:180,
children: [ ]}
]

}
]

var data3 = [ 
{name: "Decha",
 children: [ 
 {children: [ ]}
 ]},
{name: "Tansanee",
 children: [ 
 {children: [ ]}
 ]},
{
name: "Sakda",
children: 
[
{name: "Somachair",
children: [ ]}, 
{name: "Achara",
children: [ ]}
]
},
{name: "Kannika",
children: 
[
{name: "Chai",
children: 
[
{name: "Kohsoom"}, 
{name: "Boonsri"}
]
}, 
{name: "Busakrahan",
children: [ ]}
]

}
]

   
var radius = 10, gap = 50;
var nodes1 = [];
var links1 = [];
//data3 = [ {name: "p1",x:"50",y:"50", children: [{name: "c1",x:"70",y:"70"},{name: "c2",x:"90",y:"100"}]}];
data3.forEach(function(d, i) {//构造点和线的对象
    d.x = data4[i].X;
    d.y = data4[i].Y;
    nodes1.push(d);
	
    d.children.forEach(function(c, j) {   //去data4找坐标
        c.x =  data4[i].children[j].X;
        c.y =  data4[i].children[j].Y;
       
		if(data4[i].children[j].X >=1){
		 nodes1.push(c);
		//links1.push({source: data3[i], target: data3[i].children[j]});   //target不是数字
		links1.push({source: d, target: c});   //target不是数组
		}
			c.children.forEach(function(e, k) {
			e.x =  data4[i].children[j].children[k].X;
			e.y =  data4[i].children[j].children[k].Y;
			
			if(data4[i].children[j].children[k].X >=1){ //删除undefined路线和nodes
			nodes1.push(e);
			links1.push({source: c, target:e});
			}
			//links1.push({source: data3[i].children[j], target:data3[i].children[j].children[k]});
		 console.log(e);
		
    })

		
    })
	
	
})
console.log(links1);
console.log(nodes1);


  
var diagonal = d3.svg.diagonal()  //对角线生成器
        .projection(function(d) { 
		//return [d.x, d.y]; 
		return [d.x, d.y]; 
		});
		
    var node = svg.selectAll(".node")
        .data(nodes1)
        .enter()
        .append("g")
        .attr("class","node")
        .attr("transform",function(d){return "translate("+ d.x+","+ d.y+")"})
		
		 node.append("circle")
        .attr("r",4.5)

var tree = d3.layout.tree()
    .size([width,height])
    var links2 = tree.links(nodes1);   //用树的方法绘制？
var link = svg.selectAll(".link") //绘制连线
        .data(links2)
        .enter().append("path")
        .attr("d", diagonal)   //难道读进去的是字符串吗-确实
		.attr("class", "link")
		.attr("stroke", "black")
		.attr("stroke-width", "1px")
		.attr("shape-rendering", "auto")
		.attr("fill", "none");   

//绘制贝塞尔曲线结束----------------------------------------------------------------------------


</script>
</div>


<div id="TimeView" style="width: 30%;height:55%;z-index:1;position:relative;margin-top:0px;margin-left:70%;background-color:rgba(150,220,255,0.5);">
	  <script>
	  <!-- >TimeView 代码< -->
	  
	   </script>
     </div>
<div id="PlaceView" style="width: 30%;height:45%;z-index:1;position:relative;margin-bottom:0px;margin-left:70%;background-color:rgba(100,100,200,0.5);">
    
	
<!-- PlaceView 代码< -->
	<script> 
	 </script>
     </div>
</div>