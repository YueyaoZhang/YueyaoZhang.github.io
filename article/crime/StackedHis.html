<html>  
<head>  
	<meta charset="utf-8">  
	<title>堆栈图</title>  
<style>

.axis path,
.axis line{
	fill: none;
	stroke: black;
	shape-rendering: crispEdges;
}
 
.axis text {
	font-family: sans-serif;
	font-size: 11px;
}

</style>
</head> 
<body>  
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script> 
	<script>
	
	var width  = 450;	//SVG绘制区域的宽度
	var height = 240;	//SVG绘制区域的高度
			
	var svg = d3.select("body")			//选择<body>
				.append("svg")			//在<body>中添加<svg>
				.attr("width", width)	//设定<svg>的宽度属性
				.attr("height", height);//设定<svg>的高度属性
	
	//1. 确定初始数据
/*
	var dataset = [
        { name: "PC" , 
		  sales: [	{ year:2005, profit: 3000 },
					{ year:2006, profit: 1300 },
					{ year:2007, profit: 3700 },
					{ year:2008, profit: 4900 },
					{ year:2009, profit: 700 }] },
		{ name: "SmartPhone" , 
		  sales: [	{ year:2005, profit: 2000 },
					{ year:2006, profit: 4000 },
					{ year:2007, profit: 1810 },
					{ year:2008, profit: 6540 },
					{ year:2009, profit: 2820 }] },
		{ name: "Software" , 
		  sales: [	{ year:2005, profit: 1100 },
					{ year:2006, profit: 1700 },
					{ year:2007, profit: 1680 },
					{ year:2008, profit: 4000 },
					{ year:2009, profit: 4900 }] }
    ];
	
	*/
	
	
	var dataset = [
	{ name: "1" , 
	sales: [{year:1970,profit:39},
	{year:1971,profit:44},
	{year:1972,profit:37},
	{year:1973,profit:44},
{year:1974,profit:45},
{year:1975,profit:32},
{year:1976,profit:71},
{year:1977,profit:84},
{year:1978,profit:162},
{year:1979,profit:250},
{year:1980,profit:220},
{year:1981,profit:209},
{year:1982,profit:232},
{year:1983,profit:292},
{year:1984,profit:278},
{year:1985,profit:234},
{year:1986,profit:224},
{year:1987,profit:239},
{year:1988,profit:288},
{year:1989,profit:324},
{year:1990,profit:286},
{year:1991,profit:398},
{year:1992,profit:366},
{year:1994,profit:329},
{year:1995,profit:217},
{year:1996,profit:298},
{year:1997,profit:239},
{year:1998,profit:81},
{year:1999,profit:63},
{year:2000,profit:186},
{year:2001,profit:164},
{year:2002,profit:136},
{year:2003,profit:195},
{year:2004,profit:79},
{year:2005,profit:176},
{year:2006,profit:282},
{year:2007,profit:174},
{year:2008,profit:329},
{year:2009,profit:403},
{year:2010,profit:276},
{year:2011,profit:402},
{year:2012,profit:720},
{year:2013,profit:832},
{year:2014,profit:1357},
{year:2015,profit:1532},
{year:2016,profit:1154}]},
	{ name: "2" , 
	sales: [{year:1970,profit:55},
{year:1971,profit:43},
{year:1972,profit:29},
{year:1973,profit:37},
{year:1974,profit:40},
{year:1975,profit:68},
{year:1976,profit:71},
{year:1977,profit:68},
{year:1978,profit:149},
{year:1979,profit:233},
{year:1980,profit:181},
{year:1981,profit:214},
{year:1982,profit:180},
{year:1983,profit:198},
{year:1984,profit:286},
{year:1985,profit:184},
{year:1986,profit:200},
{year:1987,profit:269},
{year:1988,profit:324},
{year:1989,profit:378},
{year:1990,profit:240},
{year:1991,profit:336},
{year:1992,profit:335},
{year:1994,profit:318},
{year:1995,profit:254},
{year:1996,profit:233},
{year:1997,profit:266},
{year:1998,profit:95},
{year:1999,profit:61},
{year:2000,profit:113},
{year:2001,profit:136},
{year:2002,profit:145},
{year:2003,profit:114},
{year:2004,profit:44},
{year:2005,profit:69},
{year:2006,profit:434},
{year:2007,profit:234},
{year:2008,profit:155},
{year:2009,profit:339},
{year:2010,profit:411},
{year:2011,profit:376},
{year:2012,profit:556},
{year:2013,profit:695},
{year:2014,profit:1395},
{year:2015,profit:1292},
{year:2016,profit:1149}]},
	{name:"3",
	sales: [{year:1970,profit:69},
{year:1971,profit:50},
{year:1972,profit:38},
{year:1973,profit:46},
{year:1974,profit:62},
{year:1975,profit:74},
{year:1976,profit:59},
{year:1977,profit:114},
{year:1978,profit:125},
{year:1979,profit:259},
{year:1980,profit:254},
{year:1981,profit:207},
{year:1982,profit:277},
{year:1983,profit:232},
{year:1984,profit:374},
{year:1985,profit:224},
{year:1986,profit:300},
{year:1987,profit:227},
{year:1988,profit:358},
{year:1989,profit:320},
{year:1990,profit:398},
{year:1991,profit:275},
{year:1992,profit:514},
{year:1994,profit:419},
{year:1995,profit:270},
{year:1996,profit:233},
{year:1997,profit:256},
{year:1998,profit:63},
{year:1999,profit:184},
{year:2000,profit:95},
{year:2001,profit:169},
{year:2002,profit:83},
{year:2003,profit:195},
{year:2004,profit:80},
{year:2005,profit:198},
{year:2006,profit:120},
{year:2007,profit:228},
{year:2008,profit:321},
{year:2009,profit:412},
{year:2010,profit:368},
{year:2011,profit:447},
{year:2012,profit:655},
{year:2013,profit:796},
{year:2014,profit:1521},
{year:2015,profit:1171},
{year:2016,profit:1141}]},
	{name:"4",
	sales: [
	{year:1970,profit:79},
{year:1971,profit:57},
{year:1972,profit:22},
{year:1973,profit:44},
{year:1974,profit:46},
{year:1975,profit:57},
{year:1976,profit:78},
{year:1977,profit:63},
{year:1978,profit:112},
{year:1979,profit:212},
{year:1980,profit:298},
{year:1981,profit:208},
{year:1982,profit:251},
{year:1983,profit:221},
{year:1984,profit:370},
{year:1985,profit:156},
{year:1986,profit:249},
{year:1987,profit:306},
{year:1988,profit:276},
{year:1989,profit:342},
{year:1990,profit:339},
{year:1991,profit:327},
{year:1992,profit:367},
{year:1994,profit:366},
{year:1995,profit:169},
{year:1996,profit:249},
{year:1997,profit:234},
{year:1998,profit:66},
{year:1999,profit:88},
{year:2000,profit:98},
{year:2001,profit:116},
{year:2002,profit:106},
{year:2003,profit:83},
{year:2004,profit:95},
{year:2005,profit:209},
{year:2006,profit:405},
{year:2007,profit:217},
{year:2008,profit:505},
{year:2009,profit:416},
{year:2010,profit:359},
{year:2011,profit:436},
{year:2012,profit:722},
{year:2013,profit:990},
{year:2014,profit:1474},
{year:2015,profit:1221},
{year:2016,profit:1112}]},
	{name:"5",
	sales: [
	{year:1970,profit:72},
{year:1971,profit:56},
{year:1972,profit:74},
{year:1973,profit:47},
{year:1974,profit:51},
{year:1975,profit:82},
{year:1976,profit:107},
{year:1977,profit:81},
{year:1978,profit:124},
{year:1979,profit:361},
{year:1980,profit:198},
{year:1981,profit:223},
{year:1982,profit:236},
{year:1983,profit:296},
{year:1984,profit:299},
{year:1985,profit:422},
{year:1986,profit:248},
{year:1987,profit:246},
{year:1988,profit:326},
{year:1989,profit:359},
{year:1990,profit:413},
{year:1991,profit:349},
{year:1992,profit:459},
{year:1994,profit:315},
{year:1995,profit:323},
{year:1996,profit:288},
{year:1997,profit:189},
{year:1998,profit:54},
{year:1999,profit:94},
{year:2000,profit:130},
{year:2001,profit:98},
{year:2002,profit:185},
{year:2003,profit:157},
{year:2004,profit:93},
{year:2005,profit:231},
{year:2006,profit:215},
{year:2007,profit:171},
{year:2008,profit:499},
{year:2009,profit:417},
{year:2010,profit:462},
{year:2011,profit:450},
{year:2012,profit:842},
{year:2013,profit:1101},
{year:2014,profit:1652},
{year:2015,profit:1310},
{year:2016,profit:1346}
	]
	},
	{name:"6",
	sales: [
	{year:1970,profit:61},
{year:1971,profit:24},
{year:1972,profit:34},
{year:1973,profit:27},
{year:1974,profit:52},
{year:1975,profit:49},
{year:1976,profit:86},
{year:1977,profit:145},
{year:1978,profit:99},
{year:1979,profit:250},
{year:1980,profit:273},
{year:1981,profit:175},
{year:1982,profit:164},
{year:1983,profit:251},
{year:1984,profit:249},
{year:1985,profit:296},
{year:1986,profit:344},
{year:1987,profit:295},
{year:1988,profit:335},
{year:1989,profit:272},
{year:1990,profit:394},
{year:1991,profit:350},
{year:1992,profit:307},
{year:1994,profit:243},
{year:1995,profit:289},
{year:1996,profit:190},
{year:1997,profit:308},
{year:1998,profit:41},
{year:1999,profit:183},
{year:2000,profit:167},
{year:2001,profit:80},
{year:2002,profit:108},
{year:2003,profit:62},
{year:2004,profit:156},
{year:2005,profit:144},
{year:2006,profit:120},
{year:2007,profit:588},
{year:2008,profit:510},
{year:2009,profit:432},
{year:2010,profit:376},
{year:2011,profit:399},
{year:2012,profit:768},
{year:2013,profit:853},
{year:2014,profit:1401},
{year:2015,profit:1159},
{year:2016,profit:1146}
	]
	},
	{name:"7",
	sales: [
	{year:1970,profit:68},
{year:1971,profit:24},
{year:1972,profit:61},
{year:1973,profit:33},
{year:1974,profit:33},
{year:1975,profit:43},
{year:1976,profit:80},
{year:1977,profit:133},
{year:1978,profit:77},
{year:1979,profit:160},
{year:1980,profit:224},
{year:1981,profit:196},
{year:1982,profit:216},
{year:1983,profit:218},
{year:1984,profit:345},
{year:1985,profit:263},
{year:1986,profit:266},
{year:1987,profit:297},
{year:1988,profit:340},
{year:1989,profit:323},
{year:1990,profit:371},
{year:1991,profit:514},
{year:1992,profit:389},
{year:1994,profit:257},
{year:1995,profit:305},
{year:1996,profit:276},
{year:1997,profit:337},
{year:1998,profit:105},
{year:1999,profit:158},
{year:2000,profit:157},
{year:2001,profit:78},
{year:2002,profit:93},
{year:2003,profit:117},
{year:2004,profit:113},
{year:2005,profit:268},
{year:2006,profit:266},
{year:2007,profit:223},
{year:2008,profit:553},
{year:2009,profit:467},
{year:2010,profit:410},
{year:2011,profit:387},
{year:2012,profit:743},
{year:2013,profit:1167},
{year:2014,profit:1728},
{year:2015,profit:1260},
{year:2016,profit:1104}
	]
	},
	{name:"8",
	sales: [
	{year:1970,profit:42},
{year:1971,profit:47},
{year:1972,profit:49},
{year:1973,profit:37},
{year:1974,profit:31},
{year:1975,profit:67},
{year:1976,profit:72},
{year:1977,profit:136},
{year:1978,profit:101},
{year:1979,profit:210},
{year:1980,profit:183},
{year:1981,profit:265},
{year:1982,profit:224},
{year:1983,profit:225},
{year:1984,profit:331},
{year:1985,profit:266},
{year:1986,profit:236},
{year:1987,profit:289},
{year:1988,profit:260},
{year:1989,profit:366},
{year:1990,profit:339},
{year:1991,profit:426},
{year:1992,profit:390},
{year:1994,profit:212},
{year:1995,profit:247},
{year:1996,profit:234},
{year:1997,profit:349},
{year:1998,profit:125},
{year:1999,profit:113},
{year:2000,profit:120},
{year:2001,profit:568},
{year:2002,profit:142},
{year:2003,profit:35},
{year:2004,profit:121},
{year:2005,profit:260},
{year:2006,profit:238},
{year:2007,profit:200},
{year:2008,profit:461},
{year:2009,profit:401},
{year:2010,profit:409},
{year:2011,profit:341},
{year:2012,profit:815},
{year:2013,profit:1034},
{year:2014,profit:1358},
{year:2015,profit:1286},
{year:2016,profit:1152}
	]
	},
	{name:"9",
	sales: [
	{year:1970,profit:42},
{year:1971,profit:37},
{year:1972,profit:35},
{year:1973,profit:37},
{year:1974,profit:47},
{year:1975,profit:71},
{year:1976,profit:73},
{year:1977,profit:97},
{year:1978,profit:127},
{year:1979,profit:177},
{year:1980,profit:216},
{year:1981,profit:187},
{year:1982,profit:173},
{year:1983,profit:236},
{year:1984,profit:294},
{year:1985,profit:205},
{year:1986,profit:216},
{year:1987,profit:289},
{year:1988,profit:238},
{year:1989,profit:499},
{year:1990,profit:294},
{year:1991,profit:406},
{year:1992,profit:456},
{year:1994,profit:245},
{year:1995,profit:300},
{year:1996,profit:287},
{year:1997,profit:257},
{year:1998,profit:65},
{year:1999,profit:79},
{year:2000,profit:227},
{year:2001,profit:141},
{year:2002,profit:75},
{year:2003,profit:74},
{year:2004,profit:105},
{year:2005,profit:119},
{year:2006,profit:158},
{year:2007,profit:165},
{year:2008,profit:268},
{year:2009,profit:341},
{year:2010,profit:527},
{year:2011,profit:341},
{year:2012,profit:642},
{year:2013,profit:955},
{year:2014,profit:1280},
{year:2015,profit:1100},
{year:2016,profit:1039}
	]
	},
	{name:"10",
	sales: [
	{year:1970,profit:55},
{year:1971,profit:26},
{year:1972,profit:36},
{year:1973,profit:36},
{year:1974,profit:53},
{year:1975,profit:96},
{year:1976,profit:83},
{year:1977,profit:165},
{year:1978,profit:128},
{year:1979,profit:222},
{year:1980,profit:240},
{year:1981,profit:234},
{year:1982,profit:251},
{year:1983,profit:259},
{year:1984,profit:233},
{year:1985,profit:217},
{year:1986,profit:199},
{year:1987,profit:250},
{year:1988,profit:326},
{year:1989,profit:472},
{year:1990,profit:323},
{year:1991,profit:528},
{year:1992,profit:508},
{year:1994,profit:240},
{year:1995,profit:315},
{year:1996,profit:305},
{year:1997,profit:279},
{year:1998,profit:114},
{year:1999,profit:165},
{year:2000,profit:172},
{year:2001,profit:99},
{year:2002,profit:94},
{year:2003,profit:59},
{year:2004,profit:118},
{year:2005,profit:145},
{year:2006,profit:185},
{year:2007,profit:332},
{year:2008,profit:328},
{year:2009,profit:419},
{year:2010,profit:372},
{year:2011,profit:402},
{year:2012,profit:774},
{year:2013,profit:1157},
{year:2014,profit:1324},
{year:2015,profit:1268},
{year:2016,profit:1130}
	]
	},
	{name:"11",
	sales: [
	{year:1970,profit:41},
{year:1971,profit:39},
{year:1972,profit:29},
{year:1973,profit:36},
{year:1974,profit:65},
{year:1975,profit:47},
{year:1976,profit:81},
{year:1977,profit:76},
{year:1978,profit:126},
{year:1979,profit:153},
{year:1980,profit:207},
{year:1981,profit:200},
{year:1982,profit:137},
{year:1983,profit:233},
{year:1984,profit:239},
{year:1985,profit:231},
{year:1986,profit:166},
{year:1987,profit:314},
{year:1988,profit:319},
{year:1989,profit:377},
{year:1990,profit:274},
{year:1991,profit:434},
{year:1992,profit:532},
{year:1994,profit:219},
{year:1995,profit:169},
{year:1996,profit:212},
{year:1997,profit:218},
{year:1998,profit:90},
{year:1999,profit:142},
{year:2000,profit:182},
{year:2001,profit:135},
{year:2002,profit:104},
{year:2003,profit:107},
{year:2004,profit:73},
{year:2005,profit:74},
{year:2006,profit:163},
{year:2007,profit:533},
{year:2008,profit:431},
{year:2009,profit:337},
{year:2010,profit:467},
{year:2011,profit:662},
{year:2012,profit:686},
{year:2013,profit:1208},
{year:2014,profit:1224},
{year:2015,profit:1161},
{year:2016,profit:1101}
	]
	},
	{name:"12",
	sales: [
	{year:1970,profit:26},
{year:1971,profit:23},
{year:1972,profit:50},
{year:1973,profit:48},
{year:1974,profit:52},
{year:1975,profit:53},
{year:1976,profit:60},
{year:1977,profit:152},
{year:1978,profit:194},
{year:1979,profit:171},
{year:1980,profit:168},
{year:1981,profit:268},
{year:1982,profit:203},
{year:1983,profit:209},
{year:1984,profit:197},
{year:1985,profit:217},
{year:1986,profit:211},
{year:1987,profit:162},
{year:1988,profit:330},
{year:1989,profit:291},
{year:1990,profit:217},
{year:1991,profit:339},
{year:1992,profit:450},
{year:1994,profit:295},
{year:1995,profit:223},
{year:1996,profit:251},
{year:1997,profit:268},
{year:1998,profit:34},
{year:1999,profit:64},
{year:2000,profit:167},
{year:2001,profit:123},
{year:2002,profit:60},
{year:2003,profit:65},
{year:2004,profit:84},
{year:2005,profit:115},
{year:2006,profit:164},
{year:2007,profit:174},
{year:2008,profit:443},
{year:2009,profit:336},
{year:2010,profit:385},
{year:2011,profit:428},
{year:2012,profit:576},
{year:2013,profit:1208},
{year:2014,profit:1146},
{year:2015,profit:1091},
{year:2016,profit:915}
	]
	}
];
	
	//2. 转换数据
	var stack = d3.layout.stack()
					.values(function(d){ return d.sales; })
					.x(function(d){ return d.year; })
					.y(function(d){ return d.profit; });

	var data = stack(dataset);

	console.log(data);
		
		
	//3. 绘制

	//外边框
	var padding = { left:40, right:35, top:30, bottom:30 };
	
	//创建x轴比例尺
	var xRangeWidth = width - padding.left - padding.right;//X轴的长度
		
	//var xScale = d3.scale.ordinal()
					//.domain(data[0].sales.map(function(d){ return d.year; }))
					//.rangeBands([0, xRangeWidth],0.8);//第二个参数控制住柱间距离
					
	var xScale = d3.scale.ordinal()
					.domain(data[0].sales.map(function(d){ return d.year; }))
					.rangeBands([0, xRangeWidth],0.8);//第二个参数控制住柱间距离
					
	//当按照序列坐标轴时， ticks不起作用  can't edit the amount of ticks with an ordinal scale?
					

	//创建y轴比例尺
	
	//最大利润（定义域的最大值）
	var maxProfit = d3.max(data[data.length-1].sales, function(d){ 
							return d.y0 + d.y; 
					});
	
	//最大高度（值域的最大值）
	var yRangeWidth = height - padding.top - padding.bottom;
	
	var yScale = d3.scale.linear()
					.domain([0, maxProfit])		//定义域
					.range([0, yRangeWidth]);	//值域
	
	
	//颜色比例尺
	var color = d3.scale.category10();
	
	//添加分组元素
	var groups = svg.selectAll("g")
					.data(data)
					.enter()
					.append("g")
					.style("fill",function(d,i){ return color(i); });
		
	//添加矩形
	var rects = groups.selectAll("rect")
					.data(function(d){ return d.sales; })
					.enter()
					.append("rect")
					.attr("x",function(d){ return xScale(d.year); })
					.attr("y",function(d){ return yRangeWidth - yScale( d.y0 + d.y ); })
					.attr("width",function(d){ return xScale.rangeBand(); })
					.attr("height",function(d){ return yScale(d.y); })
					.attr("transform","translate(" + padding.left + "," + padding.top + ")");
	
	//添加坐标轴
	var xAxis = d3.svg.axis()
				.scale(xScale)
				.orient("bottom")
				.ticks(5)
				.tickValues([1970,1975,1980,1985,1990,1995,2000,2005,2010,2015]); // 分成5等分，有时d3会根据可用空间和它自己的计算多画几个或者少画几个
				//.tickSubdivide(4);  // 刻度值与坐标轴之间的距离
				
				
		
	yScale.range([yRangeWidth, 0.5]);
	
	var yAxis = d3.svg.axis()
					.scale(yScale)
					.orient("left")
					.ticks(5);
					
	svg.append("g")
			.attr("class","axis")
			.attr("transform","translate(" + padding.left + "," + (height - padding.bottom) +  ")")
			.call(xAxis);
				
	svg.append("g")
			.attr("class","axis")
			.attr("transform","translate(" + padding.left + "," + (height - padding.bottom - yRangeWidth) +  ")")
			.call(yAxis); 
			
	//添加分组标签
	var labHeight = 10;
	var labRadius = 3;
	
	var labelCircle = groups.append("circle")
						.attr("cx",function(d){ return width - padding.right*0.98; })
						.attr("cy",function(d,i){ return padding.top * 2 + labHeight * i; })
						.attr("r",labRadius);
					
	var labelText = groups.append("text")
						.attr("x",function(d){ return width - padding.right*0.8; })
						.attr("y",function(d,i){ return padding.top * 2 + labHeight * i; })
						.attr("dy",labRadius/2)
						.text(function(d){ return d.name; });
			
</script>	
		
</body>  
</html>  